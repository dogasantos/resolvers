name: CI

on:
  workflow_dispatch:
  schedule:
    - cron: "00 00 * * *"
permissions:
  contents: write
  # Need to add 'releases: write' permission for creating a release
  releases: write

jobs:
  build:
    env:
      TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.20'
        
    - name: Install necessary tools
      run: sudo apt-get update && sudo apt-get install -y curl git
      
    - name: Install dnscheck (with custom modifications)
      run: go install github.com/dogasantos/dnscheck/cmd/dnscheck@latest
      
    - name: Get measurements
      run: curl https://raw.githubusercontent.com/dogasantos/resolver-mesaure/refs/heads/main/measurements.go > measurements.go
      
    - name: Compile measurements
      run: go build -o measurements measurements.go

    - name: Fetch initial resolver list
      run: |
        curl -s https://raw.githubusercontent.com/blechschmidt/massdns/master/lists/resolvers.txt > initial_resolvers.txt
        sort -u initial_resolvers.txt -o initial_resolvers.txt
        echo "Initial list of resolvers fetched and deduplicated."
        
    - name: Run fast dnscheck (Optimized)
      run: |
        "$(go env GOPATH)/bin/dnscheck" -l initial_resolvers.txt -r 100 -w 100 > resolvers.txt
        echo "Final working resolvers list saved to resolvers.txt"
        
    - name: Run DNS Speed Check
      run: |
        ./measurements
        mv resolvers.cleaned resolvers.txt
        
    - name: Commit results
      id: commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: Update DNS data (Optimized)
        files: measurements.txt faster-resolvers.txt resolvers.txt
        # Set the branch to push to, which is typically the default branch
        branch: ${{ github.ref_name }}
        
    # --- New Steps for Tagging and Releasing ---
    
    - name: Get current date for versioning
      id: date
      run: echo "VERSION=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

    - name: Create Tag and Release
      # Only run if a commit was actually made (i.e., files changed)
      if: steps.commit.outputs.changes_detected == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.date.outputs.VERSION }}
        name: DNS Resolver List Update ${{ steps.date.outputs.VERSION }}
        body: |
          Automated update of the DNS resolver list.
          - Updated resolvers.txt based on latest checks.
          - Included speed measurements and faster-resolvers list.
        files: |
          resolvers.txt
          measurements.txt
          faster-resolvers.txt
