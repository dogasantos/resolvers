name: CI

on:
  workflow_dispatch:
  schedule:
    - cron: "00 00 * * *"
permissions:
  contents: write

jobs:
  build:
    env:
      TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: false
        
    - name: Install necessary tools
      run: sudo apt-get update && sudo apt-get install -y curl git
      
    - name: Build dnscheck from source (Bypassing Go Cache)
      run: |
        # Clone the repository to ensure we get the latest version with the -r and -w flags
        git clone https://github.com/dogasantos/dnscheck.git
        cd dnscheck
        # Build the binary from the source code
        go build -o ../dnscheck_bin ./cmd/dnscheck
        cd ..
        # Verify the binary was built correctly
        if ! ./dnscheck_bin -h | grep -q -- "-r"; then
          echo "::error::The locally built dnscheck binary does not support the required -r flag. Please check the source code in your repository."
          exit 1
        fi
      
    - name: Get measurements
      run: curl https://raw.githubusercontent.com/dogasantos/resolver-mesaure/refs/heads/main/measurements.go > measurements.go
      
    - name: Compile measurements
      run: go build -o measurements measurements.go

    - name: Fetch initial resolver list
      run: |
        curl -s https://raw.githubusercontent.com/blechschmidt/massdns/master/lists/resolvers.txt > initial_resolvers.txt
        sort -u initial_resolvers.txt -o initial_resolvers.txt
        echo "Initial list of resolvers fetched and deduplicated."
        
    - name: Run fast dnscheck (Optimized )
      run: |
        ./dnscheck_bin -l initial_resolvers.txt -r 100 -w 100 > resolvers.txt
        echo "Final working resolvers list saved to resolvers.txt"
        
    - name: Run DNS Speed Check
      run: |
        ./measurements
        mv resolvers.cleaned resolvers.txt
        
    # --- Custom Logic for Versioning and Commit Check ---
    
    - name: Get current date for versioning
      id: version
      run: echo "tag=v$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
      
    - name: Check for changes
      id: git-check
      run: |
        # Configure git for the check
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all files that might have changed
        git add measurements.txt faster-resolvers.txt resolvers.txt
        
        # Check if there are any changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "::notice::Changes detected. Proceeding with commit and release."
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "::notice::No changes detected. Skipping commit and release."
        fi

    - name: No changes detected
      if: steps.git-check.outputs.changed == 'false'
      run: |
        echo "âœ“ No changes detected in resolver data. Skipping commit, tag, and release."
        
    - name: Commit and Push changes
      if: steps.git-check.outputs.changed == 'true'
      run: |
        git commit -m "Update DNS data ${{ steps.version.outputs.tag }}"
        git push "https://${GITHUB_ACTOR}:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:${GITHUB_REF} --follow-tags

    - name: Create Tag and Release
      if: steps.git-check.outputs.changed == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: DNS Resolver List Update ${{ steps.version.outputs.tag }}
        body_path: release_notes.md
        files: |
          resolvers.txt
          measurements.txt
          faster-resolvers.txt
        draft: false
        prerelease: false
